from .base_detector import BaseDetector
from util import *

SNARK_SCALAR_FIELD = "0x30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000001"

class SnarkScalarFieldDetector(BaseDetector):
    
    def detect_after_execution(self, instruction: Instruction):
        if instruction.operation in ["GT", "LT"]:
            if self.executor.stack.has_element_on_topOrSecond(SNARK_SCALAR_FIELD):
                if self.debug:
                    print("SNARK Scalar Field constraint detected at offset {}".format(instruction.offset))
                raise Exception("SNARK Scalar Field constraint detected")
        
        if not self.executor.stack.has_element("[Variable] "+SNARK_SCALAR_FIELD):
            # break from this branch
            return False, "SNARK Scalar Field not in stack any more"
            
        return True, "Normal"

    def get_entry_point_idx(self):
        # find the location of SNARK SCALAR FIELD in the instructions
        snark_scalar_field_idx = []
        for i, instruction in enumerate(self.instructions):
            if instruction.data == SNARK_SCALAR_FIELD:
                snark_scalar_field_idx.append(i)
        
        return snark_scalar_field_idx
        
        # # find the location of "LT", "GT" in the instructions
        # lt_gt_idx = []
        # for i, instruction in enumerate(self.instructions):
        #     if instruction.operation in ["LT", "GT"]:
        #         lt_gt_idx.append(i)

        # # for each SNARK SCALAR FIELD, find if there is "LT", "GT" after close distance
        # valid_snark_scalar_field_idx = []
        # for target_index in snark_scalar_field_idx:
        #     # if there are "LT", "GT" instructions in close distance
        #     can_execute = False
        #     for idx in lt_gt_idx:
        #         if idx > target_index and idx - target_index < 32:
        #             can_execute = True
        #             break
        #     if can_execute:
        #         valid_snark_scalar_field_idx.append(target_index)

        # return valid_snark_scalar_field_idx
    